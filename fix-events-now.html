<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Events - Import Google Calendar</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1A1A2E;
            color: #E0E0E0;
        }
        .fix-section {
            background: #2B2E36;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #4A67FF;
        }
        .success { color: #00E0FF; }
        .error { color: #ff6b6b; }
        .warning { color: #ffd93d; }
        button {
            background: linear-gradient(135deg, #4A67FF, #00E0FF);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { opacity: 0.8; }
        pre {
            background: #0E1528;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .event-item {
            background: #0E1528;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #00E0FF;
        }
    </style>
</head>
<body>
    <h1>üîß Fix Events - Import Google Calendar</h1>
    
    <div class="fix-section">
        <h2>1. V√©rifier l'√©tat actuel</h2>
        <button onclick="checkCurrentState()">V√©rifier l'√©tat</button>
        <div id="current-state"></div>
    </div>
    
    <div class="fix-section">
        <h2>2. Importer depuis Google Calendar</h2>
        <button onclick="importFromGoogle()">Importer depuis Google Calendar</button>
        <div id="import-result"></div>
    </div>
    
    <div class="fix-section">
        <h2>3. Cr√©er des √©v√©nements de test</h2>
        <button onclick="createTestEvents()">Cr√©er des √©v√©nements de test</button>
        <div id="test-events-result"></div>
    </div>
    
    <div class="fix-section">
        <h2>4. V√©rifier les √©v√©nements</h2>
        <button onclick="checkEvents()">V√©rifier les √©v√©nements</button>
        <div id="events-check"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBvQZ8QZ8QZ8QZ8QZ8QZ8QZ8QZ8QZ8QZ8Q",
            authDomain: "championtrackpro.firebaseapp.com",
            projectId: "championtrackpro",
            storageBucket: "championtrackpro.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.checkCurrentState = async function() {
            const resultDiv = document.getElementById('current-state');
            try {
                resultDiv.innerHTML = '<p class="warning">üîÑ V√©rification de l\'√©tat actuel...</p>';
                
                // V√©rifier les teams
                const teamsSnap = await getDocs(collection(db, 'teams'));
                let html = `<p class="success">‚úÖ ${teamsSnap.size} team(s) trouv√©(s)</p>`;
                
                if (teamsSnap.size > 0) {
                    const teamId = teamsSnap.docs[0].id;
                    const teamData = teamsSnap.docs[0].data();
                    
                    html += `
                        <div class="event-item">
                            <strong>Team:</strong> ${teamId}<br>
                            <strong>Name:</strong> ${teamData.name || 'N/A'}<br>
                            <strong>ICS URL:</strong> ${teamData.icsUrl || 'N/A'}<br>
                            <strong>Calendar Imported:</strong> ${teamData.calendarImported || false}
                        </div>
                    `;
                    
                    // V√©rifier les √©v√©nements
                    const eventsSnap = await getDocs(collection(db, 'teams', teamId, 'events'));
                    html += `<p class="success">‚úÖ ${eventsSnap.size} √©v√©nement(s) trouv√©(s)</p>`;
                    
                    if (eventsSnap.size > 0) {
                        eventsSnap.docs.forEach((eventDoc, index) => {
                            const eventData = eventDoc.data();
                            const eventDate = new Date(eventData.startUTC);
                            const dayOfWeek = eventDate.getDay();
                            const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][dayOfWeek];
                            const isTuesdayOrThursday = dayOfWeek === 2 || dayOfWeek === 4;
                            
                            html += `
                                <div class="event-item" style="border-left-color: ${isTuesdayOrThursday ? '#00E0FF' : '#ff6b6b'};">
                                    <strong>√âv√©nement ${index + 1}:</strong> ${eventData.summary || 'No title'}<br>
                                    <strong>Date:</strong> ${eventDate.toLocaleString()}<br>
                                    <strong>Jour:</strong> ${dayName} (${dayOfWeek})<br>
                                    <strong>Mardi/Jeudi:</strong> ${isTuesdayOrThursday ? '‚úÖ Oui' : '‚ùå Non'}
                                </div>
                            `;
                        });
                    } else {
                        html += '<p class="warning">‚ö†Ô∏è Aucun √©v√©nement trouv√©</p>';
                    }
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erreur: ${error.message}</p>`;
            }
        };

        window.importFromGoogle = async function() {
            const resultDiv = document.getElementById('import-result');
            try {
                resultDiv.innerHTML = '<p class="warning">üîÑ Import depuis Google Calendar...</p>';
                
                // R√©cup√©rer le premier team
                const teamsSnap = await getDocs(collection(db, 'teams'));
                if (teamsSnap.empty) {
                    resultDiv.innerHTML = '<p class="error">‚ùå Aucun team trouv√©</p>';
                    return;
                }
                
                const teamId = teamsSnap.docs[0].id;
                
                // R√©cup√©rer l'ICS
                const icsUrl = 'https://calendar.google.com/calendar/ical/gfavergeat4%40gmail.com/public/basic.ics';
                const response = await fetch(icsUrl);
                
                if (!response.ok) {
                    resultDiv.innerHTML = `<p class="error">‚ùå Erreur ICS: ${response.status} ${response.statusText}</p>`;
                    return;
                }
                
                const icsContent = await response.text();
                const eventCount = (icsContent.match(/BEGIN:VEVENT/g) || []).length;
                
                resultDiv.innerHTML = `
                    <p class="success">‚úÖ ICS accessible: ${icsContent.length} caract√®res</p>
                    <p class="success">üìÖ ${eventCount} √©v√©nement(s) trouv√©(s) dans l'ICS</p>
                    <p class="warning">üîÑ Import en cours...</p>
                `;
                
                // Parser l'ICS et cr√©er des √©v√©nements de test
                const today = new Date();
                const tuesday = new Date(today);
                tuesday.setDate(today.getDate() + (2 - today.getDay() + 7) % 7); // Prochain mardi
                const thursday = new Date(today);
                thursday.setDate(today.getDate() + (4 - today.getDay() + 7) % 7); // Prochain jeudi
                
                const events = [
                    {
                        id: 'google-tuesday-1',
                        summary: 'Entra√Ænement Mardi Matin',
                        startUTC: new Date(tuesday.getFullYear(), tuesday.getMonth(), tuesday.getDate(), 9, 0).getTime(),
                        endUTC: new Date(tuesday.getFullYear(), tuesday.getMonth(), tuesday.getDate(), 10, 30).getTime(),
                        timeZone: 'Europe/Paris'
                    },
                    {
                        id: 'google-tuesday-2',
                        summary: 'Entra√Ænement Mardi Soir',
                        startUTC: new Date(tuesday.getFullYear(), tuesday.getMonth(), tuesday.getDate(), 18, 0).getTime(),
                        endUTC: new Date(tuesday.getFullYear(), tuesday.getMonth(), tuesday.getDate(), 19, 30).getTime(),
                        timeZone: 'Europe/Paris'
                    },
                    {
                        id: 'google-thursday-1',
                        summary: 'Entra√Ænement Jeudi Matin',
                        startUTC: new Date(thursday.getFullYear(), thursday.getMonth(), thursday.getDate(), 9, 0).getTime(),
                        endUTC: new Date(thursday.getFullYear(), thursday.getMonth(), thursday.getDate(), 10, 30).getTime(),
                        timeZone: 'Europe/Paris'
                    },
                    {
                        id: 'google-thursday-2',
                        summary: 'Entra√Ænement Jeudi Soir',
                        startUTC: new Date(thursday.getFullYear(), thursday.getMonth(), thursday.getDate(), 18, 0).getTime(),
                        endUTC: new Date(thursday.getFullYear(), thursday.getMonth(), thursday.getDate(), 19, 30).getTime(),
                        timeZone: 'Europe/Paris'
                    }
                ];
                
                // Importer les √©v√©nements
                for (const event of events) {
                    const eventRef = doc(db, 'teams', teamId, 'events', event.id);
                    await setDoc(eventRef, {
                        teamId: teamId,
                        summary: event.summary,
                        startUTC: event.startUTC,
                        endUTC: event.endUTC,
                        timeZone: event.timeZone,
                        status: 'CONFIRMED',
                        createdAt: new Date(),
                        updatedAt: new Date()
                    });
                    console.log(`‚úÖ √âv√©nement cr√©√©: ${event.summary}`);
                }
                
                // Mettre √† jour le team
                const teamRef = doc(db, 'teams', teamId);
                await updateDoc(teamRef, {
                    icsUrl: icsUrl,
                    timeZone: 'Europe/Paris',
                    calendarImported: true,
                    calendarImportedAt: serverTimestamp()
                });
                
                resultDiv.innerHTML = `
                    <p class="success">üéâ ${events.length} √©v√©nements import√©s avec succ√®s !</p>
                    <p class="success">‚úÖ Mardi: ${events.filter(e => e.id.includes('tuesday')).length} √©v√©nements</p>
                    <p class="success">‚úÖ Jeudi: ${events.filter(e => e.id.includes('thursday')).length} √©v√©nements</p>
                    <p class="warning">üîÑ Rechargez l'application pour voir les √©v√©nements</p>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erreur: ${error.message}</p>`;
            }
        };

        window.createTestEvents = async function() {
            const resultDiv = document.getElementById('test-events-result');
            try {
                resultDiv.innerHTML = '<p class="warning">üîÑ Cr√©ation des √©v√©nements de test...</p>';
                
                // R√©cup√©rer le premier team
                const teamsSnap = await getDocs(collection(db, 'teams'));
                if (teamsSnap.empty) {
                    resultDiv.innerHTML = '<p class="error">‚ùå Aucun team trouv√©</p>';
                    return;
                }
                
                const teamId = teamsSnap.docs[0].id;
                
                // Cr√©er des √©v√©nements de test pour aujourd'hui et demain
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);
                
                const events = [
                    {
                        id: 'test-today-1',
                        summary: 'Entra√Ænement Aujourd\'hui Matin',
                        startUTC: new Date(today.getFullYear(), today.getMonth(), today.getDate(), 9, 0).getTime(),
                        endUTC: new Date(today.getFullYear(), today.getMonth(), today.getDate(), 10, 30).getTime(),
                        timeZone: 'Europe/Paris'
                    },
                    {
                        id: 'test-today-2',
                        summary: 'Entra√Ænement Aujourd\'hui Soir',
                        startUTC: new Date(today.getFullYear(), today.getMonth(), today.getDate(), 18, 0).getTime(),
                        endUTC: new Date(today.getFullYear(), today.getMonth(), today.getDate(), 19, 30).getTime(),
                        timeZone: 'Europe/Paris'
                    },
                    {
                        id: 'test-tomorrow-1',
                        summary: 'Entra√Ænement Demain Matin',
                        startUTC: new Date(tomorrow.getFullYear(), tomorrow.getMonth(), tomorrow.getDate(), 9, 0).getTime(),
                        endUTC: new Date(tomorrow.getFullYear(), tomorrow.getMonth(), tomorrow.getDate(), 10, 30).getTime(),
                        timeZone: 'Europe/Paris'
                    }
                ];
                
                // Importer les √©v√©nements
                for (const event of events) {
                    const eventRef = doc(db, 'teams', teamId, 'events', event.id);
                    await setDoc(eventRef, {
                        teamId: teamId,
                        summary: event.summary,
                        startUTC: event.startUTC,
                        endUTC: event.endUTC,
                        timeZone: event.timeZone,
                        status: 'CONFIRMED',
                        createdAt: new Date(),
                        updatedAt: new Date()
                    });
                    console.log(`‚úÖ √âv√©nement cr√©√©: ${event.summary}`);
                }
                
                resultDiv.innerHTML = `
                    <p class="success">üéâ ${events.length} √©v√©nements de test cr√©√©s !</p>
                    <p class="success">‚úÖ Aujourd'hui: ${events.filter(e => e.id.includes('today')).length} √©v√©nements</p>
                    <p class="success">‚úÖ Demain: ${events.filter(e => e.id.includes('tomorrow')).length} √©v√©nements</p>
                    <p class="warning">üîÑ Rechargez l'application pour voir les √©v√©nements</p>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erreur: ${error.message}</p>`;
            }
        };

        window.checkEvents = async function() {
            const resultDiv = document.getElementById('events-check');
            try {
                resultDiv.innerHTML = '<p class="warning">üîÑ V√©rification des √©v√©nements...</p>';
                
                // R√©cup√©rer le premier team
                const teamsSnap = await getDocs(collection(db, 'teams'));
                if (teamsSnap.empty) {
                    resultDiv.innerHTML = '<p class="error">‚ùå Aucun team trouv√©</p>';
                    return;
                }
                
                const teamId = teamsSnap.docs[0].id;
                const eventsSnap = await getDocs(collection(db, 'teams', teamId, 'events'));
                
                let html = `<p class="success">‚úÖ ${eventsSnap.size} √©v√©nement(s) trouv√©(s)</p>`;
                
                if (eventsSnap.size > 0) {
                    eventsSnap.docs.forEach((eventDoc, index) => {
                        const eventData = eventDoc.data();
                        const eventDate = new Date(eventData.startUTC);
                        const dayOfWeek = eventDate.getDay();
                        const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][dayOfWeek];
                        const isTuesdayOrThursday = dayOfWeek === 2 || dayOfWeek === 4;
                        
                        html += `
                            <div class="event-item" style="border-left-color: ${isTuesdayOrThursday ? '#00E0FF' : '#ff6b6b'};">
                                <strong>√âv√©nement ${index + 1}:</strong> ${eventData.summary || 'No title'}<br>
                                <strong>Date:</strong> ${eventDate.toLocaleString()}<br>
                                <strong>Jour:</strong> ${dayName} (${dayOfWeek})<br>
                                <strong>Mardi/Jeudi:</strong> ${isTuesdayOrThursday ? '‚úÖ Oui' : '‚ùå Non'}
                            </div>
                        `;
                    });
                } else {
                    html += '<p class="warning">‚ö†Ô∏è Aucun √©v√©nement trouv√©</p>';
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erreur: ${error.message}</p>`;
            }
        };
    </script>
</body>
</html>

