import React, { useState } from "react";
import { Alert } from "react-native";
import { useNavigation } from "@react-navigation/native";
import { createUserWithEmailAndPassword } from "firebase/auth";
import { auth } from "../services/firebaseConfig";
import { CreateAccount as StitchCreateAccount } from "../src/stitch_components";

export default function Register() {
  const nav = useNavigation();
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [loading, setLoading] = useState(false);

  async function handleCreate() {
    try {
      if (!email || !password) {
        Alert.alert("Inscription", "Email et mot de passe requis.");
        return;
      }
      setLoading(true);
      const cred = await createUserWithEmailAndPassword(
        auth,
        String(email).trim(),
        String(password)
      );
      Alert.alert("Inscription", "Compte créé : " + (cred?.user?.email || ""));
      // Une fois inscrit, on bascule vers l'app (AuthGate détectera l'utilisateur)
      nav.reset({ index: 0, routes: [{ name: "App" }] });
    } catch (e) {
      Alert.alert("Erreur d'inscription", (e?.code || "") + " " + (e?.message || String(e)));
      console.log("[REGISTER ERROR]", e);
    } finally {
      setLoading(false);
    }
  }

  return (
    <StitchCreateAccount
      email={email}
      setEmail={setEmail}
      password={password}
      setPassword={setPassword}
      onCreateAccount={handleCreate}
      onBackToLogin={() => nav.goBack()}
      loading={loading}
    />
  );
}