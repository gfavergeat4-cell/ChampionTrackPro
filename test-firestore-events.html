<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Firestore - √âv√©nements</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1A1A2E;
            color: #E0E0E0;
        }
        .test-section {
            background: #2B2E36;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #4A67FF;
        }
        .success { color: #00E0FF; }
        .error { color: #ff6b6b; }
        .warning { color: #ffd93d; }
        button {
            background: linear-gradient(135deg, #4A67FF, #00E0FF);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { opacity: 0.8; }
        pre {
            background: #0E1528;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .event-item {
            background: #0E1528;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #00E0FF;
        }
    </style>
</head>
<body>
    <h1>üîç Test Firestore - √âv√©nements</h1>
    
    <div class="test-section">
        <h2>1. Test de connexion Firebase</h2>
        <button onclick="testConnection()">Tester la connexion</button>
        <div id="connection-result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Lister les teams</h2>
        <button onclick="listTeams()">Lister les teams</button>
        <div id="teams-result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Lister les √©v√©nements</h2>
        <button onclick="listEvents()">Lister les √©v√©nements</button>
        <div id="events-result"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Test de filtrage (Mardi/Jeudi)</h2>
        <button onclick="testFiltering()">Tester le filtrage</button>
        <div id="filter-result"></div>
    </div>
    
    <div class="test-section">
        <h2>5. Test ICS Import</h2>
        <button onclick="testICS()">Tester l'ICS</button>
        <div id="ics-result"></div>
    </div>
    
    <div class="test-section">
        <h2>6. Cr√©er des √©v√©nements de test</h2>
        <button onclick="createTestEvents()">Cr√©er des √©v√©nements de test</button>
        <div id="create-result"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBvQZ8QZ8QZ8QZ8QZ8QZ8QZ8QZ8QZ8QZ8Q",
            authDomain: "championtrackpro.firebaseapp.com",
            projectId: "championtrackpro",
            storageBucket: "championtrackpro.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.testConnection = async function() {
            const resultDiv = document.getElementById('connection-result');
            try {
                resultDiv.innerHTML = '<p class="warning">üîÑ Test de connexion...</p>';
                const testCollection = collection(db, 'test');
                await getDocs(testCollection);
                resultDiv.innerHTML = '<p class="success">‚úÖ Connexion Firebase r√©ussie!</p>';
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erreur: ${error.message}</p>`;
            }
        };

        window.listTeams = async function() {
            const resultDiv = document.getElementById('teams-result');
            try {
                resultDiv.innerHTML = '<p class="warning">üîÑ R√©cup√©ration des teams...</p>';
                const teamsSnap = await getDocs(collection(db, 'teams'));
                
                let html = `<p class="success">‚úÖ ${teamsSnap.size} team(s) trouv√©(s)</p>`;
                
                teamsSnap.docs.forEach((teamDoc, index) => {
                    const teamData = teamDoc.data();
                    html += `
                        <div class="event-item">
                            <strong>Team ${index + 1}:</strong> ${teamDoc.id}<br>
                            <strong>Name:</strong> ${teamData.name || 'N/A'}<br>
                            <strong>ICS URL:</strong> ${teamData.icsUrl || 'N/A'}<br>
                            <strong>TimeZone:</strong> ${teamData.timeZone || 'N/A'}<br>
                            <strong>Calendar Imported:</strong> ${teamData.calendarImported || false}
                        </div>
                    `;
                });
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erreur: ${error.message}</p>`;
            }
        };

        window.listEvents = async function() {
            const resultDiv = document.getElementById('events-result');
            try {
                resultDiv.innerHTML = '<p class="warning">üîÑ R√©cup√©ration des √©v√©nements...</p>';
                
                // R√©cup√©rer le premier team
                const teamsSnap = await getDocs(collection(db, 'teams'));
                if (teamsSnap.empty) {
                    resultDiv.innerHTML = '<p class="error">‚ùå Aucun team trouv√©</p>';
                    return;
                }
                
                const teamId = teamsSnap.docs[0].id;
                const eventsSnap = await getDocs(collection(db, 'teams', teamId, 'events'));
                
                let html = `<p class="success">‚úÖ ${eventsSnap.size} √©v√©nement(s) trouv√©(s) pour le team ${teamId}</p>`;
                
                if (eventsSnap.size > 0) {
                    eventsSnap.docs.forEach((eventDoc, index) => {
                        const eventData = eventDoc.data();
                        const eventDate = new Date(eventData.startUTC);
                        const dayOfWeek = eventDate.getDay();
                        const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][dayOfWeek];
                        const isTuesdayOrThursday = dayOfWeek === 2 || dayOfWeek === 4;
                        
                        html += `
                            <div class="event-item" style="border-left-color: ${isTuesdayOrThursday ? '#00E0FF' : '#ff6b6b'};">
                                <strong>√âv√©nement ${index + 1}:</strong> ${eventData.summary || 'No title'}<br>
                                <strong>Date:</strong> ${eventDate.toLocaleString()}<br>
                                <strong>Jour:</strong> ${dayName} (${dayOfWeek})<br>
                                <strong>startUTC:</strong> ${eventData.startUTC}<br>
                                <strong>timeZone:</strong> ${eventData.timeZone}<br>
                                <strong>Mardi/Jeudi:</strong> ${isTuesdayOrThursday ? '‚úÖ Oui' : '‚ùå Non'}
                            </div>
                        `;
                    });
                } else {
                    html += '<p class="warning">‚ö†Ô∏è Aucun √©v√©nement trouv√© pour ce team</p>';
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erreur: ${error.message}</p>`;
            }
        };

        window.testFiltering = async function() {
            const resultDiv = document.getElementById('filter-result');
            try {
                resultDiv.innerHTML = '<p class="warning">üîÑ Test du filtrage...</p>';
                
                // R√©cup√©rer le premier team
                const teamsSnap = await getDocs(collection(db, 'teams'));
                if (teamsSnap.empty) {
                    resultDiv.innerHTML = '<p class="error">‚ùå Aucun team trouv√©</p>';
                    return;
                }
                
                const teamId = teamsSnap.docs[0].id;
                const eventsSnap = await getDocs(collection(db, 'teams', teamId, 'events'));
                
                // Filtrer pour mardi et jeudi
                const tuesdayThursdayEvents = eventsSnap.docs.filter(eventDoc => {
                    const eventData = eventDoc.data();
                    const eventDate = new Date(eventData.startUTC);
                    const dayOfWeek = eventDate.getDay();
                    return dayOfWeek === 2 || dayOfWeek === 4; // Mardi ou jeudi
                });
                
                let html = `<p class="success">‚úÖ ${tuesdayThursdayEvents.length} √©v√©nement(s) Mardi/Jeudi trouv√©(s)</p>`;
                
                if (tuesdayThursdayEvents.length > 0) {
                    tuesdayThursdayEvents.forEach((eventDoc, index) => {
                        const eventData = eventDoc.data();
                        const eventDate = new Date(eventData.startUTC);
                        html += `
                            <div class="event-item">
                                <strong>${index + 1}. ${eventData.summary}</strong><br>
                                <strong>Date:</strong> ${eventDate.toLocaleString()}<br>
                                <strong>Heure:</strong> ${eventDate.toLocaleTimeString()}
                            </div>
                        `;
                    });
                } else {
                    html += '<p class="warning">‚ö†Ô∏è Aucun √©v√©nement Mardi/Jeudi trouv√©</p>';
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erreur: ${error.message}</p>`;
            }
        };

        window.testICS = async function() {
            const resultDiv = document.getElementById('ics-result');
            try {
                resultDiv.innerHTML = '<p class="warning">üîÑ Test de l\'ICS...</p>';
                
                const icsUrl = 'https://calendar.google.com/calendar/ical/gfavergeat4%40gmail.com/public/basic.ics';
                const response = await fetch(icsUrl);
                
                if (response.ok) {
                    const icsContent = await response.text();
                    const eventCount = (icsContent.match(/BEGIN:VEVENT/g) || []).length;
                    
                    resultDiv.innerHTML = `
                        <p class="success">‚úÖ ICS accessible: ${icsContent.length} caract√®res</p>
                        <p class="success">üìÖ ${eventCount} √©v√©nement(s) trouv√©(s) dans l'ICS</p>
                        <pre>${icsContent.substring(0, 500)}...</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="error">‚ùå Erreur ICS: ${response.status} ${response.statusText}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erreur: ${error.message}</p>`;
            }
        };

        window.createTestEvents = async function() {
            const resultDiv = document.getElementById('create-result');
            try {
                resultDiv.innerHTML = '<p class="warning">üîÑ Cr√©ation des √©v√©nements de test...</p>';
                
                // R√©cup√©rer le premier team
                const teamsSnap = await getDocs(collection(db, 'teams'));
                if (teamsSnap.empty) {
                    resultDiv.innerHTML = '<p class="error">‚ùå Aucun team trouv√©</p>';
                    return;
                }
                
                const teamId = teamsSnap.docs[0].id;
                
                // Cr√©er des √©v√©nements de test pour mardi et jeudi
                const today = new Date();
                const tuesday = new Date(today);
                tuesday.setDate(today.getDate() + (2 - today.getDay() + 7) % 7); // Prochain mardi
                const thursday = new Date(today);
                thursday.setDate(today.getDate() + (4 - today.getDay() + 7) % 7); // Prochain jeudi
                
                const events = [
                    {
                        id: 'test-tuesday-1',
                        summary: 'Entra√Ænement Mardi Matin',
                        startUTC: new Date(tuesday.getFullYear(), tuesday.getMonth(), tuesday.getDate(), 9, 0).getTime(),
                        endUTC: new Date(tuesday.getFullYear(), tuesday.getMonth(), tuesday.getDate(), 10, 30).getTime(),
                        timeZone: 'Europe/Paris'
                    },
                    {
                        id: 'test-tuesday-2',
                        summary: 'Entra√Ænement Mardi Soir',
                        startUTC: new Date(tuesday.getFullYear(), tuesday.getMonth(), tuesday.getDate(), 18, 0).getTime(),
                        endUTC: new Date(tuesday.getFullYear(), tuesday.getMonth(), tuesday.getDate(), 19, 30).getTime(),
                        timeZone: 'Europe/Paris'
                    },
                    {
                        id: 'test-thursday-1',
                        summary: 'Entra√Ænement Jeudi Matin',
                        startUTC: new Date(thursday.getFullYear(), thursday.getMonth(), thursday.getDate(), 9, 0).getTime(),
                        endUTC: new Date(thursday.getFullYear(), thursday.getMonth(), thursday.getDate(), 10, 30).getTime(),
                        timeZone: 'Europe/Paris'
                    },
                    {
                        id: 'test-thursday-2',
                        summary: 'Entra√Ænement Jeudi Soir',
                        startUTC: new Date(thursday.getFullYear(), thursday.getMonth(), thursday.getDate(), 18, 0).getTime(),
                        endUTC: new Date(thursday.getFullYear(), thursday.getMonth(), thursday.getDate(), 19, 30).getTime(),
                        timeZone: 'Europe/Paris'
                    }
                ];
                
                // Importer les √©v√©nements
                for (const event of events) {
                    const eventRef = doc(db, 'teams', teamId, 'events', event.id);
                    await setDoc(eventRef, {
                        teamId: teamId,
                        summary: event.summary,
                        startUTC: event.startUTC,
                        endUTC: event.endUTC,
                        timeZone: event.timeZone,
                        status: 'CONFIRMED',
                        createdAt: new Date(),
                        updatedAt: new Date()
                    });
                    console.log(`‚úÖ √âv√©nement cr√©√©: ${event.summary}`);
                }
                
                resultDiv.innerHTML = `
                    <p class="success">üéâ ${events.length} √©v√©nements de test cr√©√©s avec succ√®s !</p>
                    <p class="success">‚úÖ Mardi: ${events.filter(e => e.id.includes('tuesday')).length} √©v√©nements</p>
                    <p class="success">‚úÖ Jeudi: ${events.filter(e => e.id.includes('thursday')).length} √©v√©nements</p>
                    <p class="warning">üîÑ Rechargez l'application pour voir les √©v√©nements</p>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erreur: ${error.message}</p>`;
            }
        };
    </script>
</body>
</html>

